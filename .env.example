-- ============================================================================
-- HOTEL LOYALTY MANAGEMENT SYSTEM - DATABASE TABLES ONLY
-- Version: 2.0 (MySQL Edition - Tables Only)
-- Database: MySQL 8.0+
-- ============================================================================

-- Create database (optional)
-- CREATE DATABASE IF NOT EXISTS hotel_loyalty_db
-- CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
-- USE hotel_loyalty_db;

-- ============================================================================
-- CORE TABLES
-- ============================================================================

-- Membership Tiers Table
CREATE TABLE membership_tiers (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
tier_name VARCHAR(20) UNIQUE NOT NULL,
tier_level INT NOT NULL,
points_threshold INT NOT NULL,
points_multiplier DECIMAL(3,2) NOT NULL,
benefits JSON,
is_active BOOLEAN DEFAULT TRUE,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

INDEX idx_tier_name (tier_name),
INDEX idx_tier_level (tier_level)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Members Table
CREATE TABLE members (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
member_number VARCHAR(20) UNIQUE NOT NULL,

-- Identity Information
first_name VARCHAR(100) NOT NULL,
last_name VARCHAR(100) NOT NULL,
qatar_id_or_passport VARCHAR(50) UNIQUE NOT NULL,
id_type ENUM('QATAR_ID', 'PASSPORT') NOT NULL,
date_of_birth DATE,

-- Contact Information
email VARCHAR(255) UNIQUE NOT NULL,
phone VARCHAR(20) UNIQUE NOT NULL,
preferred_communication ENUM('EMAIL', 'SMS') DEFAULT 'EMAIL',

-- Authentication
password_hash VARCHAR(255) NOT NULL,
email_verified BOOLEAN DEFAULT FALSE,
email_verified_at TIMESTAMP NULL,
email_verification_token VARCHAR(255),
failed_login_attempts INT DEFAULT 0,
locked_until TIMESTAMP NULL,
password_reset_token VARCHAR(255),
password_reset_expires TIMESTAMP NULL,

-- QR Code
qr_code_path VARCHAR(500),
qr_code_data TEXT,

-- Membership & Points
membership_tier_id BIGINT UNSIGNED NOT NULL,
current_points INT DEFAULT 100,
lifetime_points INT DEFAULT 100,

-- Referral
referral_code VARCHAR(20) UNIQUE NOT NULL,
referred_by_member_id BIGINT UNSIGNED,

-- Status
status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') DEFAULT 'ACTIVE',
enrolled_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

-- Timestamps
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

INDEX idx_email (email),
INDEX idx_phone (phone),
INDEX idx_member_number (member_number),
INDEX idx_qatar_id (qatar_id_or_passport),
INDEX idx_referral_code (referral_code),
INDEX idx_tier_id (membership_tier_id),
INDEX idx_status (status),
INDEX idx_referred_by (referred_by_member_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Users Table (Admin/Staff)
CREATE TABLE users (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
email VARCHAR(255) UNIQUE NOT NULL,
password_hash VARCHAR(255) NOT NULL,
first_name VARCHAR(100),
last_name VARCHAR(100),
role ENUM('ADMIN', 'OUTLET_STAFF', 'MANAGER') NOT NULL,
outlet_id BIGINT UNSIGNED,
is_active BOOLEAN DEFAULT TRUE,
last_login TIMESTAMP NULL,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

INDEX idx_email (email),
INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- System Settings Table
CREATE TABLE system_settings (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
setting_key VARCHAR(100) UNIQUE NOT NULL,
setting_value TEXT NOT NULL,
data_type ENUM('INTEGER', 'DECIMAL', 'STRING', 'BOOLEAN', 'JSON') NOT NULL,
description TEXT,
is_public BOOLEAN DEFAULT FALSE,
updated_by BIGINT UNSIGNED,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

INDEX idx_setting_key (setting_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Outlet Types Table
CREATE TABLE outlet_types (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_name (name),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Outlets Table
CREATE TABLE outlets (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
name VARCHAR(100) NOT NULL,
outlet_code VARCHAR(20) UNIQUE NOT NULL,
outlet_type_id BIGINT UNSIGNED NOT NULL,
location VARCHAR(100),
phone VARCHAR(20),
is_active BOOLEAN DEFAULT TRUE,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

INDEX idx_outlet_code (outlet_code),
INDEX idx_outlet_type (outlet_type_id),
INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Transactions Table (from PMS)
CREATE TABLE transactions (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
member_id BIGINT UNSIGNED NOT NULL,

-- PMS Information
check_number VARCHAR(100) UNIQUE NOT NULL,
guest_name VARCHAR(200),
department VARCHAR(50),

-- Transaction Details
transaction_date TIMESTAMP NOT NULL,
booking_reference VARCHAR(100),
hotel_property VARCHAR(100),

-- Amount Breakdown
amount_food DECIMAL(10,2) DEFAULT 0,
amount_beverage DECIMAL(10,2) DEFAULT 0,
amount_miscellaneous DECIMAL(10,2) DEFAULT 0,
amount_rooms DECIMAL(10,2) DEFAULT 0,
amount_laundry DECIMAL(10,2) DEFAULT 0,
amount_telephone DECIMAL(10,2) DEFAULT 0,
amount_dry_cleaning DECIMAL(10,2) DEFAULT 0,
amount_service_charge DECIMAL(10,2) DEFAULT 0,
amount_washing DECIMAL(10,2) DEFAULT 0,
total_amount DECIMAL(10,2) GENERATED ALWAYS AS (
amount_food + amount_beverage + amount_miscellaneous + amount_rooms +
amount_laundry + amount_telephone + amount_dry_cleaning +
amount_service_charge + amount_washing
) STORED,

-- Points
points_earned INT NOT NULL DEFAULT 0,

-- Processing
processed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

INDEX idx_member_id (member_id),
INDEX idx_transaction_date (transaction_date),
INDEX idx_check_number (check_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Points Ledger Table
CREATE TABLE points_ledger (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
member_id BIGINT UNSIGNED NOT NULL,
transaction_id BIGINT UNSIGNED,
redemption_id BIGINT UNSIGNED,

-- Point Change
points_change INT NOT NULL,
points_type ENUM('EARNED', 'REDEEMED', 'EXPIRED', 'ADJUSTED', 'REFERRAL_BONUS', 'REGISTRATION_BONUS') NOT NULL,

-- Balance After Transaction
current_points_after INT NOT NULL,
lifetime_points_after INT NOT NULL,

-- Expiration
expiry_date DATE,
expired BOOLEAN DEFAULT FALSE,

-- Metadata
description TEXT,
adjusted_by BIGINT UNSIGNED,
adjustment_reason TEXT,

-- Timestamps
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

INDEX idx_member_id (member_id),
INDEX idx_points_type (points_type),
INDEX idx_expiry (expiry_date, expired),
INDEX idx_transaction (transaction_id),
INDEX idx_redemption (redemption_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Reward Categories Table
CREATE TABLE reward_categories (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
name VARCHAR(50) UNIQUE NOT NULL,
slug VARCHAR(50) UNIQUE NOT NULL,
description TEXT,
display_order INT DEFAULT 0,
is_active BOOLEAN DEFAULT TRUE,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

INDEX idx_slug (slug),
INDEX idx_is_active (is_active),
INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;


-- Rewards Catalog Table
CREATE TABLE rewards (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
name VARCHAR(255) NOT NULL,
description TEXT,
points_required INT NOT NULL,
qar_value DECIMAL(10,2),

-- Categorization
category_id BIGINT UNSIGNED NOT NULL,
tier_requirement_id BIGINT UNSIGNED NULL,

-- Availability
available_quantity INT,
is_unlimited BOOLEAN DEFAULT FALSE,

-- Media
image_url VARCHAR(500),

-- Terms
terms_conditions TEXT,

-- Validity
valid_from TIMESTAMP NULL,
valid_until TIMESTAMP NULL,
is_active BOOLEAN DEFAULT TRUE,

-- Timestamps
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

INDEX idx_category (category_id),
INDEX idx_tier_requirement (tier_requirement_id),
INDEX idx_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Redemptions Table
CREATE TABLE redemptions (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
member_id BIGINT UNSIGNED NOT NULL,
reward_id BIGINT UNSIGNED,
outlet_id BIGINT UNSIGNED,
staff_user_id BIGINT UNSIGNED,

-- Redemption Type and Amount
points_used INT NOT NULL,
qar_amount DECIMAL(10,2),

-- Codes
redemption_code VARCHAR(50) UNIQUE NOT NULL,

-- Status
status ENUM('PENDING', 'OTP_SENT', 'COMPLETED', 'CANCELLED', 'EXPIRED') DEFAULT 'PENDING',

-- Timestamps
initiated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
completed_at TIMESTAMP NULL,
cancelled_at TIMESTAMP NULL,
cancellation_reason TEXT,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

INDEX idx_member_id (member_id),
INDEX idx_reward_id (reward_id),
INDEX idx_status (status),
INDEX idx_outlet_id (outlet_id),
INDEX idx_redemption_code (redemption_code),
INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- OTP Verifications Table
CREATE TABLE otp_verifications (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
redemption_id BIGINT UNSIGNED NOT NULL,

-- OTP Details
otp_code VARCHAR(6) NOT NULL,
phone_or_email VARCHAR(255) NOT NULL,
channel ENUM('SMS', 'EMAIL'),

-- Verification
attempts INT DEFAULT 0,
max_attempts INT DEFAULT 3,
verified_at TIMESTAMP NULL,

-- Status
status ENUM('PENDING', 'VERIFIED', 'EXPIRED', 'FAILED') DEFAULT 'PENDING',

-- Timestamps
sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
expires_at TIMESTAMP NOT NULL,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

INDEX idx_redemption_id (redemption_id),
INDEX idx_status (status),
INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Referrals Table
CREATE TABLE referrals (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
referrer_member_id BIGINT UNSIGNED NOT NULL,
referred_member_id BIGINT UNSIGNED,

-- Referral Info
referral_code VARCHAR(20) NOT NULL,
referred_email VARCHAR(255),
referred_phone VARCHAR(20),

-- Bonus
bonus_points_awarded INT DEFAULT 20,
points_ledger_id BIGINT UNSIGNED,

-- Status
status ENUM('PENDING', 'COMPLETED', 'CANCELLED') DEFAULT 'PENDING',

-- Timestamps
invited_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
completed_at TIMESTAMP NULL,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

INDEX idx_referrer (referrer_member_id),
INDEX idx_referred (referred_member_id),
INDEX idx_status (status),
INDEX idx_referral_code (referral_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tier History Table
CREATE TABLE tier_history (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
member_id BIGINT UNSIGNED NOT NULL,
from_tier VARCHAR(20) NOT NULL,
to_tier VARCHAR(20) NOT NULL,
lifetime_points_at_upgrade INT,
current_points_at_upgrade INT,
upgraded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

INDEX idx_member_id (member_id),
INDEX idx_upgraded_at (upgraded_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Digital Wallet Cards Table
CREATE TABLE wallet_cards (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
member_id BIGINT UNSIGNED NOT NULL,

-- Wallet Type
wallet_type ENUM('APPLE_WALLET', 'GOOGLE_PAY') NOT NULL,

-- Pass Details
pass_type_id VARCHAR(100),
serial_number VARCHAR(100) UNIQUE NOT NULL,
authentication_token VARCHAR(255),
pass_url VARCHAR(500),

-- Status
is_active BOOLEAN DEFAULT TRUE,
last_updated TIMESTAMP NULL,

-- Timestamps
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

INDEX idx_member_id (member_id),
INDEX idx_serial_number (serial_number),
INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Notifications Table
CREATE TABLE notifications (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
member_id BIGINT UNSIGNED,

-- Notification Content
notification_type ENUM('POINTS_EARNED', 'POINTS_EXPIRING', 'POINTS_EXPIRED',
'TIER_UPGRADED', 'REFERRAL_BONUS', 'REDEMPTION_CONFIRMED',
'WELCOME', 'PASSWORD_RESET', 'OTHER') NOT NULL,
title VARCHAR(255) NOT NULL,
message TEXT NOT NULL,

-- Delivery
channel ENUM('EMAIL', 'SMS', 'PUSH', 'IN_APP') NOT NULL,
status ENUM('PENDING', 'SENT', 'FAILED', 'READ') DEFAULT 'PENDING',

-- Metadata
metadata JSON,
error_message TEXT,

-- Timestamps
scheduled_for TIMESTAMP NULL,
sent_at TIMESTAMP NULL,
read_at TIMESTAMP NULL,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

INDEX idx_member_id (member_id),
INDEX idx_status (status),
INDEX idx_notification_type (notification_type),
INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- PMS Import Logs Table
CREATE TABLE pms_import_logs (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

-- Import Details
import_type ENUM('API', 'CSV', 'MANUAL'),
file_name VARCHAR(255),
file_size_kb INT,

-- Processing Statistics
records_processed INT DEFAULT 0,
records_successful INT DEFAULT 0,
records_failed INT DEFAULT 0,
records_duplicate INT DEFAULT 0,

-- Results
error_details JSON,
summary JSON,

-- Status
status ENUM('PROCESSING', 'COMPLETED', 'FAILED', 'PARTIAL') DEFAULT 'PROCESSING',

-- User
imported_by BIGINT UNSIGNED,

-- Timestamps
started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
completed_at TIMESTAMP NULL,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

INDEX idx_import_type (import_type),
INDEX idx_status (status),
INDEX idx_started_at (started_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Scheduled Jobs Table
CREATE TABLE scheduled_jobs (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
job_type VARCHAR(50) UNIQUE NOT NULL,
description TEXT,
schedule_cron VARCHAR(50),
is_active BOOLEAN DEFAULT TRUE,
last_run_at TIMESTAMP NULL,
last_run_status ENUM('SUCCESS', 'FAILED', 'RUNNING'),
last_run_duration_ms INT,
next_run_at TIMESTAMP NULL,
error_message TEXT,
run_count INT DEFAULT 0,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

INDEX idx_job_type (job_type),
INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Audit Logs Table
CREATE TABLE audit_logs (
id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

-- Actor
user_id BIGINT UNSIGNED,
member_id BIGINT UNSIGNED,

-- Action
action VARCHAR(100) NOT NULL,
entity_type VARCHAR(50) NOT NULL,
entity_id BIGINT UNSIGNED,

-- Changes
old_values JSON,
new_values JSON,

-- Context
ip_address VARCHAR(45),
user_agent TEXT,
request_id VARCHAR(100),

-- Timestamp
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

INDEX idx_user_id (user_id),
INDEX idx_member_id (member_id),
INDEX idx_entity (entity_type, entity_id),
INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================================================
-- FOREIGN KEY CONSTRAINTS
-- ============================================================================

ALTER TABLE members
ADD CONSTRAINT fk_members_tier
FOREIGN KEY (membership_tier_id) REFERENCES membership_tiers(id);

ALTER TABLE members
ADD CONSTRAINT fk_members_referred_by
FOREIGN KEY (referred_by_member_id) REFERENCES members(id) ON DELETE SET NULL;

ALTER TABLE users
ADD CONSTRAINT fk_users_outlet
FOREIGN KEY (outlet_id) REFERENCES outlets(id) ON DELETE SET NULL;

ALTER TABLE system_settings
ADD CONSTRAINT fk_settings_updated_by
FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL;

ALTER TABLE transactions
ADD CONSTRAINT fk_transactions_member
FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE;

ALTER TABLE points_ledger
ADD CONSTRAINT fk_points_member
FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE,
ADD CONSTRAINT fk_points_transaction
FOREIGN KEY (transaction_id) REFERENCES transactions(id) ON DELETE SET NULL,
ADD CONSTRAINT fk_points_redemption
FOREIGN KEY (redemption_id) REFERENCES redemptions(id) ON DELETE SET NULL,
ADD CONSTRAINT fk_points_adjusted_by
FOREIGN KEY (adjusted_by) REFERENCES users(id) ON DELETE SET NULL;

ALTER TABLE rewards
ADD CONSTRAINT fk_rewards_category
FOREIGN KEY (category_id) REFERENCES reward_categories(id),
ADD CONSTRAINT fk_rewards_tier
FOREIGN KEY (tier_requirement_id) REFERENCES membership_tiers(id);

ALTER TABLE outlets
ADD CONSTRAINT fk_outlets_type
FOREIGN KEY (outlet_type_id) REFERENCES outlet_types(id);

ALTER TABLE redemptions
ADD CONSTRAINT fk_redemptions_member
FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE,
ADD CONSTRAINT fk_redemptions_reward
FOREIGN KEY (reward_id) REFERENCES rewards(id) ON DELETE SET NULL,
ADD CONSTRAINT fk_redemptions_outlet
FOREIGN KEY (outlet_id) REFERENCES outlets(id) ON DELETE SET NULL,
ADD CONSTRAINT fk_redemptions_staff
FOREIGN KEY (staff_user_id) REFERENCES users(id) ON DELETE SET NULL;

ALTER TABLE otp_verifications
ADD CONSTRAINT fk_otp_redemption
FOREIGN KEY (redemption_id) REFERENCES redemptions(id) ON DELETE CASCADE;

ALTER TABLE referrals
ADD CONSTRAINT fk_referrals_referrer
FOREIGN KEY (referrer_member_id) REFERENCES members(id) ON DELETE CASCADE,
ADD CONSTRAINT fk_referrals_referred
FOREIGN KEY (referred_member_id) REFERENCES members(id) ON DELETE SET NULL,
ADD CONSTRAINT fk_referrals_points
FOREIGN KEY (points_ledger_id) REFERENCES points_ledger(id) ON DELETE SET NULL;

ALTER TABLE tier_history
ADD CONSTRAINT fk_tier_history_member
FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE;

ALTER TABLE wallet_cards
ADD CONSTRAINT fk_wallet_member
FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE;

ALTER TABLE notifications
ADD CONSTRAINT fk_notifications_member
FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE;

ALTER TABLE pms_import_logs
ADD CONSTRAINT fk_pms_logs_imported_by
FOREIGN KEY (imported_by) REFERENCES users(id) ON DELETE SET NULL;

ALTER TABLE audit_logs
ADD CONSTRAINT fk_audit_user
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
ADD CONSTRAINT fk_audit_member
FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE SET NULL;

-- ============================================================================
-- DEFAULT DATA
-- ============================================================================

-- Insert Membership Tiers
INSERT INTO membership_tiers (tier_name, tier_level, points_threshold, points_multiplier, benefits) VALUES
('SILVER', 1, 0, 1.00, '{"description": "Standard membership with base benefits"}'),
('GOLD', 2, 10000, 1.25, '{"description": "Enhanced benefits with 25% point bonus"}'),
('PLATINUM', 3, 25000, 1.50, '{"description": "Premium benefits with 50% point bonus"}');

-- Insert System Settings
INSERT INTO system_settings (setting_key, setting_value, data_type, description, is_public) VALUES
('base_registration_points', '100', 'INTEGER', 'Points awarded upon member registration', FALSE),
('referral_bonus_points', '20', 'INTEGER', 'Points awarded for successful referrals', FALSE),
('gold_tier_threshold', '10000', 'INTEGER', 'Lifetime points required for Gold tier', FALSE),
('platinum_tier_threshold', '25000', 'INTEGER', 'Lifetime points required for Platinum tier', FALSE),
('points_expiry_months', '12', 'INTEGER', 'Months until points expire', FALSE),
('qar_to_points_rate', '1', 'INTEGER', 'Conversion rate: 1 QAR = X points', FALSE),
('points_to_qar_rate', '0.10', 'DECIMAL', 'Conversion rate: 1 point = X QAR', TRUE),
('max_referral_points_per_year', '500', 'INTEGER', 'Maximum referral points per year', FALSE),
('otp_expiry_minutes', '10', 'INTEGER', 'OTP validity duration in minutes', FALSE),
('otp_max_attempts', '3', 'INTEGER', 'Maximum OTP verification attempts', FALSE),
('password_min_length', '8', 'INTEGER', 'Minimum password length', FALSE),
('account_lockout_attempts', '5', 'INTEGER', 'Failed login attempts before lockout', FALSE),
('account_lockout_duration_minutes', '30', 'INTEGER', 'Account lockout duration', FALSE);

-- Insert Outlet Types
INSERT INTO outlet_types (name, description) VALUES
('Restaurant', 'Dining facilities and restaurants'),
('Bar', 'Bar and lounge areas'),
('Pool Bar', 'Poolside bar and beverage service'),
('Spa', 'Spa and wellness center'),
('Gym', 'Fitness center and gym facilities'),
('Room Service', 'In-room dining and services'),
('Gift Shop', 'Retail and souvenir shop'),
('Business Center', 'Business services and facilities'),
('Concierge', 'Concierge and guest services'),
('Salon', 'Beauty salon and hair services'),
('Laundry', 'Laundry and dry cleaning services'),
('Recreation', 'Recreation and activities desk'),
('Golf Course', 'Golf facilities'),
('Kids Club', 'Children activities and club'),
('Valet Parking', 'Parking and valet services'),
('Other', 'Other outlet types');

-- Insert Reward Categories
INSERT INTO reward_categories (name, slug, description, display_order) VALUES
('Dining', 'dining', 'Restaurant and food rewards', 1),
('Spa & Wellness', 'spa-wellness', 'Spa treatments and wellness services', 2),
('Room Upgrade', 'room-upgrade', 'Room and suite upgrades', 3),
('Merchandise', 'merchandise', 'Gift shop items and products', 4),
('Experience', 'experience', 'Special experiences and activities', 5),
('Other', 'other', 'Miscellaneous rewards', 99);


-- Update sample outlets insert
INSERT INTO outlets (name, outlet_code, outlet_type_id, location, is_active) VALUES
('Main Restaurant', 'RES-001', 1, 'Ground Floor', TRUE),
('Lobby Bar', 'BAR-001', 2, 'Lobby', TRUE),
('Pool Bar', 'BAR-002', 3, 'Pool Area', TRUE),
('Wellness Spa', 'SPA-001', 4, 'Second Floor', TRUE),
('Fitness Center', 'GYM-001', 5, 'Ground Floor', TRUE),
('Room Service', 'RMS-001', 6, 'All Floors', TRUE),
('Gift Shop', 'GFT-001', 7, 'Lobby', TRUE);

-- Insert Scheduled Jobs
INSERT INTO scheduled_jobs (job_type, description, schedule_cron, is_active) VALUES
('EXPIRE_POINTS', 'Expire points older than 12 months', '0 2 * * *', TRUE),
('UPDATE_TIERS', 'Recalculate member tiers based on points', '0 3 * * *', TRUE),
('SEND_EXPIRY_NOTIFICATIONS', 'Send notifications for points expiring in 30 days', '0 10 * * *', TRUE),
('UPDATE_WALLET_CARDS', 'Update Apple/Google wallet cards', '0 4 * * *', TRUE),
('CLEANUP_OLD_OTPS', 'Delete expired OTP records', '0 1 * * *', TRUE);

-- Insert Default Admin User
-- Password: Admin@123456 (Change immediately!)
INSERT INTO users (email, password_hash, first_name, last_name, role, is_active) VALUES
('admin@hotel.com', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5yvX9Z5QD0kza', 'System', 'Administrator', 'ADMIN', TRUE);

-- ============================================================================
-- SCHEMA COMPLETE
-- ============================================================================